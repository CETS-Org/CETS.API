name: .NET CI - CETS.API

on:
  push:
    branches: [ develop, staging, main ]
  pull_request:
    branches: [ develop, staging, main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # Checkout CETS.API repo into the current directory
      - name: Checkout API repo
        uses: actions/checkout@v4
        with:
          path: main-repo 

      # Checkout CETS.Core repo into another subdirectory
      - name: Checkout CETS.Core repo
        uses: actions/checkout@v4
        with:
          repository: CETS-Org/CETS.Core
          path: core-repo
          token: ${{ secrets.GH_PAT }}

      # Step 2: Checkout the Core repository into a 'core-repo' directory
      - name: Checkout CETS.Core repo
        uses: actions/checkout@v4
        with:
          repository: CETS-Org/CETS.Core 
          path: core-repo
          token: ${{ secrets.GH_PAT }}

      # Step 3: Setup the .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

           # === THE IMPROVED, DYNAMIC FIX ===
      - name: Dynamically Update Solution File Paths
        working-directory: ./main-repo
        run: |
          CORE_PROJECT_PATHS=$(find ../core-repo -name '*.csproj')

          if [ -z "$CORE_PROJECT_PATHS" ]; then
            echo "No .csproj files found in core-repo. Skipping update."
            exit 0
          fi
          
          echo "Found Core Projects to add:"
          echo "$CORE_PROJECT_PATHS"

          # Remove existing core project references first.
          for project_path in $CORE_PROJECT_PATHS; do
              project_file=$(basename "$project_path")
              project_name="${project_file%.*}"
              
              echo "Attempting to remove $project_name from solution..."
              dotnet sln CETS.API.sln remove "$project_name" || true
          done

          echo "Adding all discovered projects to solution..."
          dotnet sln CETS.API.sln add $CORE_PROJECT_PATHS

      - name: Restore dependencies
        working-directory: ./main-repo
        run: dotnet restore CETS.API.sln

      - name: Build
        working-directory: ./main-repo
        run: dotnet build CETS.API.sln -c Release --no-restore

      - name: Test
        working-directory: ./main-repo
        run: dotnet test CETS.API.sln --no-build --verbosity normal