name: .NET CI - CETS.API + CETS.Core

on:
  push:
    branches: [ develop, staging, main ]
    paths: [ '**/*.cs', '**/*.csproj', '**/*.sln', '.github/workflows/dotnet-ci.yml' ]
  pull_request:
    branches: [ develop, staging, main ]

jobs:
  build-test:
    runs-on: ubuntu-latest

    steps:
      # Checkout CETS.API repo
      - name: Checkout API repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout CETS.Core (same branch)
        id: core_branch
        continue-on-error: true
        uses: actions/checkout@v4
        with:
          repository: CETS-Org/CETS.Core
          ref: ${{ github.ref_name }}
          path: CETS.Core
          token: ${{ secrets.GH_PAT }}

      # Fallback if branch doesn't exist in CETS.Core
      - name: Checkout CETS.Core (fallback to main)
        if: steps.core_branch.outcome == 'failure'
        uses: actions/checkout@v4
        with:
          repository: CETS-Org/CETS.Core
          ref: main
          path: CETS.Core
          token: ${{ secrets.GH_PAT }}

      # Step 2: Checkout the Core repository into a 'core-repo' directory
      - name: Checkout CETS.Core repo
        uses: actions/checkout@v4
        with:
          repository: CETS-Org/CETS.Core 
          path: core-repo
          token: ${{ secrets.GH_PAT }}

      # Step 3: Setup the .NET SDK
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      # (Debug) Print solution layout to debug paths
      - name: Show workspace
        run: |
          pwd
          ls -la
          find . -maxdepth 2 -type f -name "*.sln" -print

          

      # Restore dependencies
      - name: Restore
        run: dotnet restore CETS.API.sln

      # Build
      - name: Build
        run: dotnet build CETS.API.sln -c Release --no-restore

      # Run tests (if test projects are in the solution)
      - name: Test
        run: dotnet test  CETS.API.sln --no-build
